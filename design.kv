# --- SCREEN MANAGER ---
<SaviScreenManager>:
    WelcomeScreen:
    LoginScreen:
    RegisterScreen:
    HomeScreen:
    DetallesJuntaScreen:
    InvitarScreen:
    InfoJuntaScreen:
    IntegrantesPagosScreen:
    ReportarScreen:
    SorteoScreen:
#COMPONENTE: Menú Compartir 
<MenuCompartir>:
    size_hint: None, None
    width: dp(300)
    height: dp(250)
    radius: [20]
    md_bg_color: 1, 1, 1, 1
    auto_dismiss: True
    background_color: 0, 0, 0, 0.5

    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        
        MDLabel:
            text: "Compartir invitación"
            font_style: "H6"
            halign: "center"
            bold: True
            adaptive_height: True
            theme_text_color: "Primary"
            
        MDLabel:
            text: root.url_invitacion
            font_style: "Caption"
            halign: "center"
            theme_text_color: "Secondary"
            adaptive_height: True
            
        Widget:
            size_hint_y: None
            height: dp(10)
            
        MDFillRoundFlatButton:
            text: "Copiar Enlace"
            size_hint_x: 1
            height: dp(45)
            md_bg_color: 1, 0.5, 0, 1
            on_release: root.compartir("Copiar Link")
            
        MDFillRoundFlatButton:
            text: "WhatsApp"
            size_hint_x: 1
            height: dp(45)
            md_bg_color: 0.1, 0.8, 0.1, 1
            on_release: root.compartir("WhatsApp")

# --- COMPONENTE: Campo de Formulario Personalizado ---
<CampoFormulario@MDBoxLayout>:
    icon: "pencil"
    hint_text: ""
    input_filter: None
    text: ""
    is_readonly: False
    on_text_callback: None
    
    orientation: 'horizontal'
    adaptive_height: True
    spacing: dp(15)
    pos_hint: {"center_y": .5}

    MDIcon:
        icon: root.icon
        theme_text_color: "Custom"
        text_color: 1, 0.5, 0, 1 
        font_size: "28sp"
        pos_hint: {"center_y": .5}
        size_hint_x: None
        width: dp(30)

    MDCard:
        size_hint_y: None
        height: dp(48)
        radius: [10]
        elevation: 2
        md_bg_color: 1, 1, 1, 1
        line_color: 1, 0.5, 0, 0.6 
        padding: [dp(10), 0, dp(10), 0]
        
        MDTextField:
            id: text_field
            hint_text: root.hint_text
            text: root.text
            mode: "rectangle"
            line_color_normal: 0, 0, 0, 0 
            line_color_focus: 0, 0, 0, 0
            input_filter: root.input_filter
            readonly: root.is_readonly
            pos_hint: {"center_y": .5}
            on_text: root.text = self.text

# --- COMPONENTE: Tarjeta para la lista de Juntas Propias ---
<TarjetaListaJunta>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(90)
    radius: [15]
    md_bg_color: 0.98, 0.98, 0.98, 1
    line_color: 0, 0, 0, 0.1
    elevation: 2
    ripple_behavior: True
    on_release: app.ver_detalles_junta(root.nombre, root.monto)
    
    MDBoxLayout:
        orientation: 'horizontal'
        padding: [dp(15), dp(10)]
        spacing: dp(10)
        adaptive_height: True
        pos_hint: {"center_y": .5}

        MDBoxLayout:
            orientation: 'vertical'
            adaptive_height: True
            spacing: dp(5)
            pos_hint: {"center_y": .5}
            
            MDLabel:
                text: root.nombre
                font_style: "H6"
                bold: True
                theme_text_color: "Primary"
                shorten: True
                shorten_from: 'right'
                adaptive_height: True
                
            MDLabel:
                text: "Gestión activa"
                font_style: "Caption"
                theme_text_color: "Secondary"
                adaptive_height: True
        
        MDBoxLayout:
            orientation: 'vertical'
            adaptive_height: True
            spacing: dp(5)
            pos_hint: {"center_y": .5}
            size_hint_x: None
            width: dp(120)
            
            MDLabel:
                text: root.monto
                halign: "right"
                font_style: "H6"
                bold: True
                theme_text_color: "Primary"
                adaptive_height: True

# --- COMPONENTE: Tarjeta para Juntas Públicas ---
<TarjetaUnirse>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(140)
    padding: dp(15)
    radius: [15]
    md_bg_color: 1, 1, 1, 1
    line_color: 0, 0, 0, 0.1
    
    MDBoxLayout:
        orientation: 'horizontal'
        size_hint_y: None
        height: dp(30)
        MDLabel:
            text: root.nombre
            bold: True
            font_style: "Subtitle1"
        MDLabel:
            text: root.monto
            halign: "right"
            theme_text_color: "Primary"
            bold: True

    MDLabel:
        text: "Organizado por: " + root.organizador
        font_style: "Caption"
        theme_text_color: "Secondary"
    
    Widget:
        size_hint_y: None
        height: dp(10)

    MDRaisedButton:
        text: "SOLICITAR UNIRSE"
        size_hint_x: 1
        md_bg_color: app.theme_cls.primary_color
        font_size: "12sp"

# --- COMPONENTE: Tarjeta de Integrante ---
<TarjetaIntegrante>:
    orientation: 'vertical'
    size_hint_y: None
    height: dp(100)
    radius: [15]
    padding: dp(10)
    elevation: 2
    md_bg_color: 1, 1, 1, 1
    ripple_behavior: True
    on_release: root.editar_info()

    MDFloatLayout:
        MDCard:
            size_hint: None, None
            size: dp(40), dp(40)
            radius: [20]
            md_bg_color: 1, 0.9, 0.8, 1
            elevation: 0
            pos_hint: {"center_y": .5, "x": 0.05} if root.posicion_numero == "left" else {"center_y": .5, "right": 0.95}
            
            MDLabel:
                text: root.numero
                halign: "center"
                valign: "center"
                bold: True
                theme_text_color: "Custom"
                text_color: 1, 0.5, 0, 1
                font_style: "H6"

        MDLabel:
            text: root.nombre_alias
            halign: "center"
            bold: True
            font_style: "Subtitle1"
            pos_hint: {"center_x": .5, "center_y": .65}
            theme_text_color: "Primary"
            
        MDLabel:
            text: "DNI: " + root.dni if root.dni else root.usuario
            halign: "center"
            theme_text_color: "Secondary" if root.dni else "Hint"
            font_style: "Caption"
            pos_hint: {"center_x": .5, "center_y": .35}

        MDIcon:
            icon: "pencil-circle"
            font_size: "20sp"
            theme_text_color: "Hint"
            pos_hint: {"top": 1, "right": 1} if root.posicion_numero == "left" else {"top": 1, "x": 0}

# --- PANTALLA: BIENVENIDA ---
<WelcomeScreen>:
    name: 'welcome'
    MDFloatLayout:
        md_bg_color: 1, 1, 1, 1
        Carousel:
            id: intro_carousel
            loop: False
            on_index: if self.index == 2: self.scroll_timeout = 0
            MDFloatLayout:
                FitImage:
                    source: 'assets/1.png'
            MDFloatLayout:
                FitImage:
                    source: 'assets/2.png'
            MDFloatLayout:
                FitImage:
                    source: 'assets/3.png'
                MDBoxLayout:
                    orientation: 'vertical'
                    adaptive_height: True
                    padding: dp(20)
                    spacing: dp(20)
                    pos_hint: {'center_x': .5, 'center_y': .15}
                    MDFillRoundFlatButton:
                        text: "COMENZAR AHORA"
                        size_hint_x: .8
                        pos_hint: {'center_x': .5}
                        md_bg_color: 1, 0.5, 0, 1
                        on_release: root.manager.current = 'login'

# --- PANTALLA: LOGIN ---
<LoginScreen>:
    name: 'login'
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(35)
        spacing: dp(20)
        md_bg_color: 1, 1, 1, 1
        Widget:
            size_hint_y: None
            height: dp(20)
        Image:
            source: "assets/logo.png"
            size_hint: None, None
            size: dp(160), dp(160)
            pos_hint: {"center_x": 0.5}
        MDLabel:
            text: "¡Bienvenido Estimado cliente!"
            font_style: "H5"
            bold: True
            halign: "center"
            theme_text_color: "Primary"
        MDTextField:
            hint_text: "Usuario o Correo"
            mode: "round"
            icon_left: "account"
        MDTextField:
            hint_text: "Contraseña"
            mode: "round"
            password: True
            icon_left: "lock"
        MDFillRoundFlatButton:
            text: "INICIAR SESIÓN"
            size_hint_x: 1
            on_release: root.manager.current = 'home'
        MDTextButton:
            text: "¿No tienes cuenta? [b]Regístrate aquí[/b]"
            markup: True
            pos_hint: {"center_x": 0.5}
            on_release: root.manager.current = 'register'
        Widget:

# --- PANTALLA: REGISTRO ---
<RegisterScreen>:
    name: 'register'
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(35)
        spacing: dp(12)
        md_bg_color: 1, 1, 1, 1
        Image:
            source: "assets/logo.png"
            size_hint: None, None
            size: dp(160), dp(160)
            pos_hint: {"center_x": 0.5}
        MDLabel:
            text: "Crear Cuenta Nueva"
            font_style: "H5"
            bold: True
            halign: "center"
            size_hint_y: None
            height: dp(80)
        MDTextField:
            hint_text: "Nombre Completo"
            mode: "round"
            icon_left: "account-edit"
        MDTextField:
            hint_text: "Correo Electrónico"
            mode: "round"
            icon_left: "email"
        MDTextField:
            hint_text: "Número de Teléfono"
            mode: "round"
            icon_left: "phone"
        MDTextField:
            hint_text: "Contraseña"
            mode: "round"
            password: True
            icon_left: "key"
        MDFillRoundFlatButton:
            text: "REGISTRARME AHORA"
            size_hint_x: 1
            on_release: root.manager.current = 'login'
        MDTextButton:
            text: "Ya tengo cuenta, [b]Iniciar sesión[/b]"
            markup: True
            pos_hint: {"center_x": 0.5}
            on_release: root.manager.current = 'login'

# --- PANTALLA: HOME ---
<HomeScreen>:
    name: 'home'
    MDBoxLayout:
        orientation: 'vertical'
        md_bg_color: 0.98, 0.98, 0.98, 1

        MDCard:
            size_hint_y: None
            height: dp(90)
            radius: [0, 0, 0, 0] 
            md_bg_color: 0.2, 0.2, 0.2, 1
            line_color: 0, 0, 0, 0
            elevation: 4
            MDFloatLayout:
                Image:
                    source: "assets/logo2.png"
                    size_hint: None, None
                    size: dp(180), dp(80)
                    pos_hint: {"center_x": .5, "center_y": .5}
                    allow_stretch: True
                    keep_ratio: True

        MDBottomNavigation:
            id: nav_bottom
            panel_color: 1, 1, 1, 1
            text_color_active: app.theme_cls.primary_color
            text_color_normal: 0.5, 0.5, 0.5, 1

            MDBottomNavigationItem:
                name: 'tab_inicio'
                text: 'Inicio'
                icon: 'home-variant'
                MDScrollView:
                    MDBoxLayout:
                        orientation: 'vertical'
                        padding: dp(20)
                        spacing: dp(20)
                        size_hint_y: None
                        height: self.minimum_height
                        
                        MDBoxLayout:
                            orientation: 'vertical'
                            adaptive_height: True
                            spacing: dp(5)

                        MDCard:
                            size_hint_y: None
                            height: dp(180)
                            radius: [20]
                            elevation: 2
                            padding: 0
                            MDFloatLayout:
                                size_hint: 1, 1
                                FitImage:
                                    source: 'assets/4.png'
                                    radius: [20]
                                    size_hint: 1, 1
                                    pos_hint: {"center_x": .5, "center_y": .5}

                        MDGridLayout:
                            cols: 2
                            spacing: dp(15)
                            size_hint_y: None
                            height: dp(100)
                            MDCard:
                                radius: [15]
                                md_bg_color: 1, 0.5, 0, 1
                                padding: dp(10)
                                elevation: 3
                                ripple_behavior: True
                                MDBoxLayout:
                                    orientation: 'vertical'
                                    pos_hint: {"center_y": .5}
                                    spacing: dp(5)
                                    MDIcon:
                                        icon: "wallet-outline"
                                        theme_text_color: "Custom"
                                        text_color: 1, 1, 1, 1
                                        halign: "center"
                                        font_size: "32sp"
                                    MDLabel:
                                        text: "Ahorrado Total"
                                        halign: "center"
                                        theme_text_color: "Custom"
                                        text_color: 1, 1, 1, 0.9
                                        font_style: "Caption"
                                    MDLabel:
                                        text: "S/ 0.00"
                                        halign: "center"
                                        theme_text_color: "Custom"
                                        text_color: 1, 1, 1, 1
                                        font_style: "Subtitle1"
                                        bold: True
                            MDCard:
                                radius: [15]
                                md_bg_color: 1, 0.5, 0, 1 
                                padding: dp(10)
                                elevation: 3
                                ripple_behavior: True
                                MDBoxLayout:
                                    orientation: 'vertical'
                                    pos_hint: {"center_y": .5}
                                    spacing: dp(5)
                                    MDIcon:
                                        icon: "chart-line"
                                        theme_text_color: "Custom"
                                        text_color: 1, 1, 1, 1
                                        halign: "center"
                                        font_size: "32sp"
                                    MDLabel:
                                        text: "Juntas Activas"
                                        halign: "center"
                                        theme_text_color: "Custom"
                                        text_color: 1, 1, 1, 0.9
                                        font_style: "Caption"
                                    MDLabel:
                                        text: "0"
                                        halign: "center"
                                        theme_text_color: "Custom"
                                        text_color: 1, 1, 1, 1
                                        font_style: "Subtitle1"
                                        bold: True

                        MDLabel:
                            text: "¿Qué quieres hacer hoy?"
                            font_style: "H6"
                            bold: True
                            adaptive_height: True
                            theme_text_color: "Primary"

                        MDBoxLayout:
                            size_hint_y: None
                            height: dp(50)
                            spacing: dp(15)
                            MDFillRoundFlatButton:
                                text: "CREAR JUNTA"
                                font_size: "14sp"
                                size_hint_x: .5
                                md_bg_color: 1, 0.5, 0, 1
                                on_release: nav_bottom.switch_tab('tab_crear')
                            MDFillRoundFlatButton:
                                text: "BUSCAR"
                                font_size: "14sp"
                                size_hint_x: .5
                                md_bg_color: 1, 0.5, 0, 1
                                on_release: nav_bottom.switch_tab('tab_unirse')
                        
                        MDCard:
                            orientation: 'horizontal'
                            padding: dp(15)
                            spacing: dp(15)
                            size_hint_y: None
                            height: dp(90)
                            radius: [15]
                            md_bg_color: 1, 1, 1, 1
                            line_color: 1, 0.5, 0, 0.3
                            elevation: 1
                            ripple_behavior: True
                            MDIcon:
                                icon: "lightbulb-on-outline"
                                theme_text_color: "Custom"
                                text_color: 1, 0.5, 0, 1
                                font_size: "36sp"
                                pos_hint: {"center_y": .5}
                            MDBoxLayout:
                                orientation: 'vertical'
                                pos_hint: {"center_y": .5}
                                MDLabel:
                                    text: "Tip Financiero"
                                    bold: True
                                    theme_text_color: "Primary"
                                    font_style: "Subtitle2"
                                MDLabel:
                                    text: "Invierte el 10% de tus ingresos en tu junta."
                                    font_style: "Caption"
                                    theme_text_color: "Secondary"

            MDBottomNavigationItem:
                name: 'tab_mis_juntas'
                text: 'Mis juntas'
                icon: 'format-list-checks'
                MDBoxLayout:
                    orientation: 'vertical'
                    MDScrollView:
                        MDBoxLayout:
                            id: lista_juntas
                            orientation: 'vertical'
                            size_hint_y: None
                            height: self.minimum_height
                            padding: dp(15)
                            spacing: dp(15)
                            MDLabel:
                                id: mensaje_vacio
                                text: "Aquí aparecerá todas tus juntas creadas.\nUsa la pestaña 'Crear' para empezar."
                                halign: "center"
                                theme_text_color: "Secondary"
                                font_style: "Body1"
                                size_hint_y: None
                                height: dp(300)

            MDBottomNavigationItem:
                name: 'tab_unirse'
                text: 'Unirse'
                icon: 'account-multiple-plus'
                MDScrollView:
                    MDBoxLayout:
                        orientation: 'vertical'
                        padding: dp(25)
                        spacing: dp(15)
                        size_hint_y: None
                        height: self.minimum_height
                        MDCard:
                            orientation: 'vertical'
                            padding: dp(20)
                            spacing: dp(12)
                            radius: [20]
                            elevation: 2
                            size_hint_y: None
                            height: dp(180)
                            MDLabel:
                                text: "Ingresa el Código QR o Link"
                                font_style: "Subtitle1"
                                bold: True
                                halign: "left"
                                theme_text_color: "Primary"
                                size_hint_y: None
                                height: self.texture_size[1]
                            MDTextField:
                                id: input_codigo_unirse
                                hint_text: "Ej: SAVI-8823"
                                hint_text_color: app.theme_cls.primary_color
                                icon_right: "qrcode"
                                mode: "rectangle"
                            MDBoxLayout:
                                size_hint_y: None
                                height: dp(44)
                                spacing: dp(10)
                                MDBoxLayout:
                                    size_hint_x: None
                                    width: dp(96)
                                    MDIconButton:
                                        icon: "qrcode-scan"
                                        user_font_size: "20sp"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primary_color
                                        on_release: app.lanzar_scanner()
                                    MDIconButton:
                                        icon: "upload"
                                        user_font_size: "20sp"
                                        theme_icon_color: "Custom"
                                        icon_color: app.theme_cls.primary_color
                                        on_release: app.abrir_file_manager()
                                MDFillRoundFlatButton:
                                    text: "UNIRSE AHORA"
                                    size_hint_x: 1
                                    md_bg_color: 1, 0.5, 0, 1
                                    on_release: app.procesar_codigo_invitacion(input_codigo_unirse.text)

            MDBottomNavigationItem:
                name: 'tab_crear'
                text: 'Crear'
                icon: 'plus-circle'
                MDScrollView:
                    MDBoxLayout:
                        orientation: 'vertical'
                        padding: dp(20)
                        spacing: dp(10)
                        size_hint_y: None
                        height: self.minimum_height
                        
                        MDCard:
                            orientation: 'vertical'
                            size_hint_y: None
                            height: self.minimum_height
                            padding: [dp(20), dp(30)]
                            spacing: dp(25)
                            radius: [20]
                            elevation: 2
                            md_bg_color: 1, 1, 1, 1
                            
                            MDLabel:
                                text: "Nueva Junta"
                                font_style: "H6"
                                bold: True
                                theme_text_color: "Primary"
                                adaptive_height: True

                            # Nombre
                            MDTextField:
                                id: input_nombre
                                hint_text: "Nombre de la junta"
                                helper_text: "Ej: Viaje 2026, Auto Nuevo, ¡Fiesta #1!"
                                helper_text_mode: "on_focus"
                                mode: "rectangle"
                                icon_right: "pencil"
                                icon_right_color: app.theme_cls.primary_color
                                # Permitir caracteres especiales y números: usar input_type text
                                input_type: 'text'
                                # Sin filtro (None) para aceptar cualquier carácter
                                input_filter: None
                                max_text_length: 100
                            
                            # DNI (Solo por si se requiere, opcional)
                            MDTextField:
                                id: input_dni_crear
                                hint_text: "DNI Organizador"
                                mode: "rectangle"
                                input_filter: "int"
                                icon_right: "card-account-details"
                                icon_right_color: app.theme_cls.primary_color

                            # Monto
                            MDTextField:
                                id: input_monto
                                hint_text: "Monto Objetivo"
                                helper_text: "Monto total a recaudar"
                                helper_text_mode: "on_focus"
                                mode: "rectangle"
                                input_filter: "float"
                                icon_right: "cash"
                                icon_right_color: app.theme_cls.primary_color

                            # Cantidad Integrantes
                            MDTextField:
                                id: input_cantidad
                                hint_text: "Cantidad de Integrantes"
                                helper_text: "Máximo 10 personas"
                                mode: "rectangle"
                                input_filter: "int"
                                icon_right: "account-group"
                                icon_right_color: app.theme_cls.primary_color

                            # Fechas (Layout horizontal)
                            MDBoxLayout:
                                adaptive_height: True
                                spacing: dp(10)
                                
                                MDCard:
                                    size_hint_y: None
                                    height: dp(50)
                                    radius: [5]
                                    elevation: 0
                                    line_color: 0, 0, 0, 0.2
                                    ripple_behavior: True
                                    on_release: app.abrir_picker('inicio')
                                    padding: dp(10)
                                    MDBoxLayout:
                                        MDLabel:
                                            id: txt_fecha_inicio
                                            text: "Fecha Inicio"
                                            theme_text_color: "Secondary"
                                        MDIcon:
                                            icon: "calendar"
                                            theme_text_color: "Secondary"

                                MDCard:
                                    size_hint_y: None
                                    height: dp(50)
                                    radius: [5]
                                    elevation: 0
                                    line_color: 0, 0, 0, 0.2
                                    ripple_behavior: True
                                    on_release: app.abrir_picker('final')
                                    padding: dp(10)
                                    MDBoxLayout:
                                        MDLabel:
                                            id: txt_fecha_final
                                            text: "Fecha Fin"
                                            theme_text_color: "Secondary"
                                        MDIcon:
                                            icon: "calendar"
                                            theme_text_color: "Secondary"

                            # Periodo (Dropdown)
                            MDCard:
                                size_hint_y: None
                                height: dp(50)
                                radius: [5]
                                elevation: 0
                                line_color: 0, 0, 0, 0.2
                                ripple_behavior: True
                                on_release: app.abrir_menu_periodo(lbl_periodo)
                                padding: dp(10)
                                MDBoxLayout:
                                    MDLabel:
                                        id: lbl_periodo
                                        text: "Periodo de pago (Seleccionar)"
                                        theme_text_color: "Secondary"
                                    MDIcon:
                                        icon: "chevron-down"
                                        theme_text_color: "Secondary"

                            # Selección de Moneda
                            MDBoxLayout:
                                orientation: 'vertical'
                                adaptive_height: True
                                spacing: dp(5)
                                
                                MDLabel:
                                    text: "Moneda:"
                                    bold: True
                                    font_style: "Subtitle2"
                                    theme_text_color: "Secondary"
                                    adaptive_height: True
                                
                                Widget:
                                    size_hint_y: None
                                    height: dp(5)

                                MDBoxLayout:
                                    adaptive_height: True
                                    spacing: dp(15)
                                    
                                    MDCard:
                                        size_hint: .5, None
                                        height: dp(55)
                                        radius: [12]
                                        md_bg_color: (1, 0.5, 0, 1) if app.moneda_seleccionada == "Soles" else (0.96, 0.96, 0.96, 1)
                                        ripple_behavior: True
                                        on_release: app.set_moneda("Soles")
                                        elevation: 1 if app.moneda_seleccionada == "Soles" else 0
                                        
                                        MDBoxLayout:
                                            orientation: 'horizontal'
                                            padding: dp(10)
                                            spacing: dp(8)
                                            adaptive_width: True
                                            pos_hint: {"center_x": .5, "center_y": .5}
                                            MDIcon:
                                                icon: "currency-sign"
                                                theme_text_color: "Custom"
                                                text_color: (1, 1, 1, 1) if app.moneda_seleccionada == "Soles" else (0.4, 0.4, 0.4, 1)
                                            MDLabel:
                                                text: "Soles (S/)"
                                                adaptive_size: True
                                                bold: True
                                                theme_text_color: "Custom"
                                                text_color: (1, 1, 1, 1) if app.moneda_seleccionada == "Soles" else (0.4, 0.4, 0.4, 1)

                                    MDCard:
                                        size_hint: .5, None
                                        height: dp(55)
                                        radius: [12]
                                        md_bg_color: (1, 0.5, 0, 1) if app.moneda_seleccionada == "Dólares" else (0.96, 0.96, 0.96, 1)
                                        ripple_behavior: True
                                        on_release: app.set_moneda("Dólares")
                                        elevation: 1 if app.moneda_seleccionada == "Dólares" else 0
                                        
                                        MDBoxLayout:
                                            orientation: 'horizontal'
                                            padding: dp(10)
                                            spacing: dp(8)
                                            adaptive_width: True
                                            pos_hint: {"center_x": .5, "center_y": .5}
                                            MDIcon:
                                                icon: "currency-usd"
                                                theme_text_color: "Custom"
                                                text_color: (1, 1, 1, 1) if app.moneda_seleccionada == "Dólares" else (0.4, 0.4, 0.4, 1)
                                            MDLabel:
                                                text: "Dólares ($)"
                                                adaptive_size: True
                                                bold: True
                                                theme_text_color: "Custom"
                                                text_color: (1, 1, 1, 1) if app.moneda_seleccionada == "Dólares" else (0.4, 0.4, 0.4, 1)

                            Widget:
                                size_hint_y: None
                                height: dp(10)

                            # Botón de Acción Principal
                            MDFillRoundFlatButton:
                                text: "CREAR Y PUBLICAR"
                                font_size: "16sp"
                                size_hint_x: 1
                                height: dp(50)
                                md_bg_color: 1, 0.5, 0, 1 # Naranja SAVI
                                on_release: app.crear_junta(input_nombre.text, input_monto.text, input_cantidad.text, lbl_periodo.text, txt_fecha_inicio.text, txt_fecha_final.text)

            MDBottomNavigationItem:
                name: 'tab_perfil'
                text: 'Perfil'
                icon: 'account-cog'
                MDBoxLayout:
                    orientation: 'vertical'
                    padding: dp(20)
                    spacing: dp(10)
                    
                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(100)
                        spacing: dp(20)
                        MDIcon:
                            icon: "account-circle"
                            font_size: "80sp"
                        MDBoxLayout:
                            orientation: 'vertical'
                            adaptive_height: True
                            pos_hint: {"center_y": .5}
                            MDLabel:
                                text: "Usuario Savi"
                                bold: True
                                font_style: "H6"
                    
                    MDSeparator:
                    
                    MDList:
                        OneLineIconListItem:
                            text: "Mi Cuenta"
                            IconLeftWidget:
                                icon: "account-edit"
                        OneLineIconListItem:
                            text: "Seguridad"
                            IconLeftWidget:
                                icon: "shield-lock"

                    MDFillRoundFlatButton:
                        text: "CERRAR SESIÓN"
                        size_hint_x: 0.8
                        pos_hint: {"center_x": .5}
                        md_bg_color: 0.85, 0.1, 0.1, 1
                        on_release: root.manager.current = 'login'

# --- PANTALLA: DETALLES JUNTA ---
<DetallesJuntaScreen>:
    name: 'detalles_junta'
    MDBoxLayout:
        orientation: 'vertical'
        md_bg_color: 1, 1, 1, 1
        
        MDBoxLayout:
            size_hint_y: None
            height: dp(60)
            padding: dp(10)
            MDIconButton:
                icon: "chevron-left"
                on_release: root.manager.current = 'home'
            MDLabel:
                text: root.nombre_junta
                bold: True
                font_style: "H6"

        MDScrollView:
            MDBoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                padding: dp(20)
                spacing: dp(20)

                MDCard:
                    size_hint_y: None
                    height: dp(150)
                    radius: [25]
                    md_bg_color: 1, 0.96, 0.92, 1
                    line_color: 1, 0.5, 0, 0.2
                    elevation: 1
                    MDBoxLayout:
                        orientation: 'vertical'
                        padding: dp(25)
                        MDLabel:
                            text: "Monto de la junta"
                            halign: "center"
                            theme_text_color: "Secondary"
                        FitLabel:
                            text: root.monto_junta
                            halign: "center"
                            bold: True
                            theme_text_color: "Primary"
                            max_font_size: 64
                            min_font_size: 24
                            step: 1

                MDGridLayout:
                    cols: 2
                    spacing: dp(15)
                    size_hint_y: None
                    height: self.minimum_height
                    
                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(170)
                        padding: dp(15)
                        radius: [20]
                        line_color: 0, 0, 0, 0.08
                        ripple_behavior: True

                        
                        on_release: root.ir_a_info()
                        MDIcon:
                            icon: "card-bulleted-outline"
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                            theme_text_color: "Custom"
                            text_color: 0.1, 0.45, 0.85, 1
                        MDLabel:
                            text: "Detalles"
                            halign: "center"
                            bold: True
                        MDLabel:
                            text: "Consulta aquí los datos de la junta."
                            font_style: "Caption"
                            halign: "center"
                            theme_text_color: "Secondary"

                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(170)
                        padding: dp(15)
                        radius: [20]
                        line_color: 0, 0, 0, 0.08
                        ripple_behavior: True
                        on_release: root.ir_a_invitar()
                        MDIcon:
                            icon: "qrcode-scan"
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                            theme_text_color: "Custom"
                            text_color: 0.15, 0.75, 0.35, 1
                        MDLabel:
                            text: "Invitar"
                            halign: "center"
                            bold: True
                        MDLabel:
                            text: "Comparte el ID con tus contactos."
                            font_style: "Caption"
                            halign: "center"
                            theme_text_color: "Secondary"

                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(170)
                        padding: dp(15)
                        radius: [20]
                        line_color: 0, 0, 0, 0.08
                        ripple_behavior: True
                        on_release: root.ir_a_pagos()
                        MDIcon:
                            icon: "account-group"
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                            theme_text_color: "Custom"
                            text_color: 0.1, 0.45, 0.85, 1
                        MDLabel:
                            text: "Integrantes y Pagos"
                            halign: "center"
                            bold: True
                        MDLabel:
                            text: "Registra en tiempo real los pagos."
                            font_style: "Caption"
                            halign: "center"
                            theme_text_color: "Secondary"

                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(170)
                        padding: dp(15)
                        radius: [20]
                        line_color: 0, 0, 0, 0.08
                        ripple_behavior: True
                        on_release: root.ir_a_reportar()
                        MDIcon:
                            icon: "alert-octagon-outline"
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                            theme_text_color: "Custom"
                            text_color: 0.85, 0.15, 0.15, 1
                        MDLabel:
                            text: "Reportar"
                            halign: "center"
                            bold: True
                        MDLabel:
                            text: "Informa sobre faltas de pago."
                            font_style: "Caption"
                            halign: "center"
                            theme_text_color: "Secondary"

# --- PANTALLA: INVITAR ---
<InvitarScreen>:
    name: 'invitar'
    MDBoxLayout:
        orientation: 'vertical'
        md_bg_color: 1, 1, 1, 1
        
        MDBoxLayout:
            size_hint_y: None
            height: dp(60)
            padding: dp(10)
            spacing: dp(15)
            MDIconButton:
                icon: "chevron-left"
                on_release: root.manager.current = 'detalles_junta'
            MDLabel:
                text: "Invitar Miembros"
                bold: True
                font_style: "H6"

        MDScrollView:
            MDBoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                padding: dp(25)
                spacing: dp(30)
                pos_hint: {'center_x': .5}
                
                MDLabel:
                    text: "Escanea para unirte"
                    halign: "center"
                    font_style: "H5"
                    bold: True
                
                MDCard:
                    size_hint: None, None
                    size: dp(250), dp(250)
                    pos_hint: {'center_x': .5}
                    radius: [20]
                    elevation: 1
                    padding: dp(20)
                    
                    Image:
                        id: img_qr
                        source: "" 
                        allow_stretch: True
                        keep_ratio: True

                Widget:
                    size_hint_y: None
                    height: dp(6)

                MDFillRoundFlatButton:
                    text: "SUBIR QR"
                    size_hint_x: .8
                    pos_hint: {'center_x': .5}
                    on_release: app.abrir_file_manager()
                        
                MDLabel:
                    text: "O comparte este código:"
                    halign: "center"
                    theme_text_color: "Secondary"
                    
                MDCard:
                    size_hint_y: None
                    height: dp(60)
                    radius: [10]
                    md_bg_color: 0.95, 0.95, 0.95, 1
                    padding: dp(15)
                    
                    MDLabel:
                        text: root.codigo_junta
                        halign: "center"
                        bold: True
                        font_style: "H6"
                        
                    MDIconButton:
                        icon: "content-copy"
                        on_release: root.callback_compartir("Copiar Link")
                
                MDFillRoundFlatButton:
                    text: "COMPARTIR ENLACE"
                    size_hint_x: .8
                    pos_hint: {'center_x': .5}
                    on_release: root.abrir_menu_compartir()

# --- PANTALLA: INFO JUNTA ---
<InfoJuntaScreen>:
    name: 'info_junta'
    MDBoxLayout:
        orientation: 'vertical'
        md_bg_color: 0.98, 0.98, 0.98, 1
        
        MDBoxLayout:
            size_hint_y: None
            height: dp(60)
            padding: dp(10)
            spacing: dp(15)
            MDIconButton:
                icon: "chevron-left"
                on_release: root.manager.current = 'detalles_junta'
            MDLabel:
                text: "Detalles de la Junta"
                bold: True
                font_style: "H6"

        MDScrollView:
            MDBoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                padding: dp(20)
                spacing: dp(25)

                MDCard:
                    size_hint_y: None
                    height: dp(120)
                    radius: [20]
                    md_bg_color: 1, 0.95, 0.9, 1
                    line_color: 1, 0.5, 0, 0.1
                    elevation: 1
                    MDBoxLayout:
                        orientation: 'vertical'
                        padding: dp(20)
                        spacing: dp(10)
                        pos_hint: {'center_x': .5}
                        MDLabel:
                            text: "Monto de la junta"
                            halign: "center"
                            theme_text_color: "Secondary"
                            font_style: "Body1"
                        MDLabel:
                            text: root.monto
                            halign: "center"
                            font_style: "H4"
                            bold: True
                            theme_text_color: "Primary"

                MDGridLayout:
                    cols: 2
                    spacing: dp(15)
                    size_hint_y: None
                    height: self.minimum_height
                    
                    # 1. Periodo
                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(130)
                        radius: [15]
                        padding: [dp(10), dp(15)]
                        spacing: dp(8)
                        elevation: 1
                        ripple_behavior: True
                        MDLabel:
                            text: "Periodo"
                            bold: True
                            font_style: "Subtitle2"
                            halign: "center"
                            adaptive_height: True
                        MDIcon:
                            icon: "clock-outline"
                            theme_text_color: "Custom"
                            text_color: 1, 0.5, 0, 1
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                        MDLabel:
                            text: root.periodo
                            halign: "center"
                            font_style: "Caption"
                            theme_text_color: "Secondary"
                            adaptive_height: True

                    # 2. N° Personas
                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(130)
                        radius: [15]
                        padding: [dp(10), dp(15)]
                        spacing: dp(8)
                        elevation: 1
                        ripple_behavior: True
                        on_release: root.abrir_dialogo_editar_integrantes()
                        MDLabel:
                            text: "N° personas"
                            bold: True
                            font_style: "Subtitle2"
                            halign: "center"
                            adaptive_height: True
                        MDIcon:
                            icon: "format-list-numbered"
                            theme_text_color: "Custom"
                            text_color: 1, 0.5, 0, 1
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                        MDLabel:
                            text: root.num_personas + " Miembros"
                            halign: "center"
                            font_style: "Caption"
                            theme_text_color: "Secondary"
                            adaptive_height: True

                    # 3. Sorteo (reordered for cleaner layout)
                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(140)
                        radius: [15]
                        padding: dp(12)
                        spacing: dp(6)
                        elevation: 1
                        ripple_behavior: True
                        on_release: app.get_manager().current = 'sorteo'
                        MDBoxLayout:
                            orientation: 'vertical'
                            padding: dp(6)
                            spacing: dp(6)
                            size_hint_y: None
                            height: self.minimum_height
                            MDIcon:
                                icon: "account-group"
                                theme_text_color: "Custom"
                                text_color: 1, 0.5, 0, 1
                                font_size: "36sp"
                                pos_hint: {"center_x": .5}
                                size_hint_y: None
                                height: dp(44)
                            MDLabel:
                                text: "Sorteo"
                                bold: True
                                font_style: "Subtitle1"
                                halign: "center"
                                adaptive_height: True
                            MDLabel:
                                text: "Asignación y solicitudes"
                                halign: "center"
                                font_style: "Caption"
                                theme_text_color: "Secondary"
                                adaptive_height: True

                    # 4. DNI
                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(130)
                        radius: [15]
                        padding: [dp(10), dp(15)]
                        spacing: dp(8)
                        elevation: 1
                        ripple_behavior: True
                        MDLabel:
                            text: "DNI"
                            bold: True
                            font_style: "Subtitle2"
                            halign: "center"
                            adaptive_height: True
                        MDIcon:
                            icon: "card-account-details-outline"
                            theme_text_color: "Custom"
                            text_color: 1, 0.5, 0, 1
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                        MDLabel:
                            text: "Verificación activa"
                            halign: "center"
                            font_style: "Caption"
                            theme_text_color: "Secondary"
                            adaptive_height: True

                    # 5. Fecha inicio
                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(130)
                        radius: [15]
                        padding: [dp(10), dp(15)]
                        spacing: dp(8)
                        elevation: 1
                        ripple_behavior: True
                        # CAMBIO AQUÍ: Usar root directamente
                        on_release: root.abrir_calendario('inicio')
                        MDLabel:
                            text: "Fecha inicio"
                            bold: True
                            font_style: "Subtitle2"
                            halign: "center"
                            adaptive_height: True
                        MDIcon:
                            icon: "calendar-start"
                            theme_text_color: "Custom"
                            text_color: 1, 0.5, 0, 1
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                        MDLabel:
                            text: root.fecha_inicio
                            halign: "center"
                            font_style: "Caption"
                            theme_text_color: "Secondary"
                            adaptive_height: True

                    # 6. Fecha final
                    MDCard:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: dp(130)
                        radius: [15]
                        padding: [dp(10), dp(15)]
                        spacing: dp(8)
                        elevation: 1
                        ripple_behavior: True
                        # CAMBIO AQUÍ: Usar root directamente
                        on_release: root.abrir_calendario('final')
                        MDLabel:
                            text: "Fecha final"
                            bold: True
                            font_style: "Subtitle2"
                            halign: "center"
                            adaptive_height: True
                        MDIcon:
                            icon: "calendar-check"
                            theme_text_color: "Custom"
                            text_color: 1, 0.5, 0, 1
                            font_size: "36sp"
                            pos_hint: {"center_x": .5}
                        MDLabel:
                            text: root.fecha_final
                            halign: "center"
                            font_style: "Caption"
                            theme_text_color: "Secondary"
                            adaptive_height: True

# --- PANTALLA: INTEGRANTES PAGOS ---
<IntegrantesPagosScreen>:
    name: 'integrantes_pagos'
    MDBoxLayout:
        orientation: 'vertical'
        md_bg_color: 0.98, 0.98, 0.98, 1
        
        # Header
        MDBoxLayout:
            size_hint_y: None
            height: dp(60)
            padding: dp(10)
            spacing: dp(15)
            MDIconButton:
                icon: "chevron-left"
                on_release: root.manager.current = 'detalles_junta'
            MDLabel:
                text: "Integrantes y Pagos"
                bold: True
                font_style: "H6"

        MDScrollView:
            MDBoxLayout:
                orientation: 'vertical'
                adaptive_height: True
                padding: dp(15)
                spacing: dp(15)

                Widget:
                    size_hint_y: None
                    height: dp(30)

                MDGridLayout:
                    id: grid_integrantes
                    cols: 2
                    spacing: dp(15)
                    adaptive_height: True

# --- PANTALLA: SORTEO (pantalla dedicada) ---
<SorteoScreen>:
    name: 'sorteo'
    MDBoxLayout:
        orientation: 'vertical'
        MDBoxLayout:
            size_hint_y: None
            height: dp(56)
            padding: dp(8)
            MDIconButton:
                icon: 'chevron-left'
                on_release: app.get_manager().current = 'detalles_junta'
            MDLabel:
                text: 'Sorteo'
                font_style: 'H6'
                halign: 'center'
        MDScrollView:
            MDBoxLayout:
                orientation: 'vertical'
                padding: dp(16)
                spacing: dp(12)

                MDCard:
                    padding: dp(12)
                    radius: [12]
                    md_bg_color: 1,1,1,1
                    MDBoxLayout:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: self.minimum_height
                        padding: dp(6)
                        spacing: dp(10)

                        AnchorLayout:
                            size_hint_y: None
                            height: dp(64)
                            MDCard:
                                size_hint: None, None
                                size: dp(64), dp(64)
                                radius: [32]
                                md_bg_color: 1, 0.95, 0.85, 1
                                elevation: 0
                                pos_hint: {'center_x': .5, 'center_y': .5}

                        MDSeparator:

                        MDBoxLayout:
                            orientation: 'vertical'
                            size_hint_y: None
                            height: self.minimum_height
                            spacing: dp(8)

                            MDBoxLayout:
                                size_hint_y: None
                                height: dp(48)
                                spacing: dp(8)

                                MDFillRoundFlatButton:
                                    text: 'Generar Números'
                                    md_bg_color: app.theme_cls.primary_color
                                    on_release: app.get_manager().get_screen('integrantes_pagos').generar_sorteo()

                                MDRectangleFlatButton:
                                    text: 'Ver Solicitudes'
                                    on_release: app.mostrar_solicitudes_sorteo()
                                    size_hint_x: None
                                    width: dp(140)

                            MDFillRoundFlatButton:
                                text: 'Solicitar Intercambio'
                                size_hint_x: .6
                                pos_hint: {'center_x': .5}
                                md_bg_color: 1, 1, 1, 1
                                line_color: app.theme_cls.primary_color
                                text_color: app.theme_cls.primary_color
                                on_release: app.mostrar_formulario_solicitud()

                        MDLabel:
                            text: 'Asignaciones actuales'
                            font_style: 'Subtitle2'
                            halign: 'left'
                            size_hint_y: None
                            height: self.texture_size[1]

                        ScrollView:
                            do_scroll_x: False
                            MDBoxLayout:
                                id: sorteo_area
                                orientation: 'vertical'
                                adaptive_height: True

# --- PANTALLA: REPORTAR ---
<ReportarScreen>:
    name: 'reportar'
    MDBoxLayout:
        orientation: 'vertical'
        md_bg_color: 1, 1, 1, 1
        
        # Header simple para navegar atras
        MDBoxLayout:
            size_hint_y: None
            height: dp(60)
            padding: dp(10)
            MDIconButton:
                icon: "chevron-left"
                on_release: root.manager.current = 'detalles_junta'
            MDLabel:
                text: "Volver"
                bold: True
                font_style: "Subtitle1"
                valign: 'center'

        MDScrollView:
            MDBoxLayout:
                orientation: 'vertical'
                padding: dp(30)
                spacing: dp(20)
                size_hint_y: None
                height: self.minimum_height

                MDLabel:
                    text: "Hola, Luis"
                    font_style: "H5"
                    bold: True
                    adaptive_height: True
                    theme_text_color: "Primary"

                MDLabel:
                    text: "Notifica fácilmente cuando un integrante no cumpla con su cuota, manteniendo a todos informados y ayudando a gestionar el compromiso dentro del grupo."
                    font_style: "Body2"
                    theme_text_color: "Primary"
                    adaptive_height: True
                    halign: "left"

                Widget:
                    size_hint_y: None
                    height: dp(10)

                MDTextField:
                    id: input_dni
                    hint_text: "DNI"
                    mode: "rectangle"
                    input_filter: "int"
                    max_text_length: 8

                MDTextField:
                    id: input_reclamo
                    hint_text: "Describe tu reclamo."
                    mode: "rectangle"
                    multiline: True
                    max_height: dp(150)

                Widget:
                    size_hint_y: None
                    height: dp(10)

                MDFillRoundFlatButton:
                    text: "ENVIAR"
                    font_size: "16sp"
                    size_hint_x: 1
                    height: dp(50)
                    md_bg_color: 1, 0.4, 0, 1 # Naranja intenso
                    on_release: root.enviar_reporte(input_dni.text, input_reclamo.text)

                Widget:
                    size_hint_y: None
                    height: dp(20)

                Image:
                    source: "assets/5.png"
                    size_hint_y: None
                    height: dp(150)
                    allow_stretch: True
                    keep_ratio: True